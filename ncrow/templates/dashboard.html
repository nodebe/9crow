{% extends 'layout.html' %}
<!-- Secondary Menu
============================================= -->
{% block secondarymenu %}
<div class="bg-primary">
  <div class="container d-flex justify-content-center">
    <ul class="nav secondary-nav">
      <li class="nav-item"> <a class="nav-link active" href="{{url_for('users.userdashboard')}}">Dashboard</a></li>
      <li class="nav-item"> <a class="nav-link" href="{{url_for('users.userprofile')}}">Account</a></li>
      <li class="nav-item"> <a class="nav-link" href="{{url_for('users.userprofile_bank_accounts')}}">Bank Accounts</a></li>
      <li class="nav-item"> <a class="nav-link" href="{{url_for('users.profile_notifications')}}">Notifications</a></li>
    </ul>
  </div>
</div>
{% endblock secondarymenu %}
<!-- Secondary Menu end --> 
{% block body %}
  <div class="container py-4">
    <div class="row"> 
      <!-- Left Panel
      ============================================= -->
      <aside class="col-lg-3"> 
        
        <!-- Profile Details
        =============================== -->
        <div class="bg-light shadow-sm rounded text-center p-3 mb-4">
          <div class="profile-thumb mt-3 mb-4"> <img class="rounded-circle" src="../static/images/profile-thumb.jpg" alt="{{current_user.username}}">
            <div class="profile-thumb-edit custom-file bg-primary text-white" data-toggle="tooltip" title="Change Profile Picture"> <i class="fas fa-camera position-absolute"></i>
              <input type="file" class="custom-file-input" id="customFile">
            </div>
          </div>
          <p class="text-3 font-weight-500 mb-2">Hello, {{current_user.fullname}}</p>
          <p class="mb-2"><a href="{{url_for('users.userprofile')}}" class="text-5 text-light" title="Edit Profile"><i class="fas fa-edit"></i></a></p>
        </div>
        <!-- Profile Details End -->
        
        <!-- Available Balance
        =============================== -->
        <div class="bg-light shadow-sm rounded text-center p-3 mb-4">
          <div class="text-17 text-light my-3"><i class="fas fa-wallet"></i></div>
          <h3 class="text-9 font-weight-400">₦{{current_user.balance.available}}</h3>
          <p class="mb-2 text-muted opacity-8">Available Balance</p>
          
            {% if current_user.balance.available > 0 %} 
            <hr class="mx-n3">
            <div class="d-flex justify-content-center">
            <a href="{{url_for('transactions.withdraw')}}" class="btn-link">Withdraw</a>
            </div>
            {% endif %}
        </div>
        <!-- Available Balance End --> 
        
        <!-- Need Help?
        =============================== -->
        <div class="bg-light shadow-sm rounded text-center p-3 mb-4">
          <div class="text-17 text-light my-3">
            <i class="fas fa-comments"></i>
          </div>
          <h3 class="text-3 font-weight-400 my-4">Need Help?</h3>
          <p class="text-muted opacity-8 mb-4">Have questions or concerns regrading your account?<br>
            We are always here to help.</p>
          <a href="{{url_for('main.contactus')}}" class="btn btn-primary btn-block">Contact Us</a> 
        </div>
        <!-- Need Help? End --> 
        
      </aside>
      <!-- Left Panel End --> 
      
      <!-- Middle Panel
      ============================================= -->
      <div class="col-lg-9">
        
        <!-- Profile Completeness
        =============================== -->
        {% if pc < 100 %}
        <div class="bg-light shadow-sm rounded p-4 mb-4">
          <h3 class="text-5 font-weight-400 d-flex align-items-center mb-3">Profile Completeness <span class="bg-light-4 text-success rounded px-2 py-1 font-weight-400 text-2 ml-2">{{pc}}%</span></h3>
          <div class="row profile-completeness">
            <div class="col-sm-6 col-md-3 mb-4 mb-md-0">
              <div class="border rounded p-3 text-center"> <span class="d-block text-10 text-light mt-2 mb-3"><i class="fas fa-mobile-alt"></i></span> {% if current_user.phone == None %} 
                <span class="text-5 d-block text-light mt-4 mb-3">
                  <i class="far fa-circle "></i>
                </span>
                <p class="mb-0"><a class="btn-link stretched-link" href="{{url_for('users.userprofile')}}">Add Phone Number</a></p>
              {% else %}
                <span class="text-5 d-block text-success mt-4 mb-3"><i class="fas fa-check-circle"></i></span>
                <p class="mb-0">Mobile Added</p>
              {% endif %}
              </div>
            </div>
            <div class="col-sm-6 col-md-3 mb-4 mb-md-0">
              <div class="border rounded p-3 text-center"> <span class="d-block text-10 text-light mt-2 mb-3"><i class="fas fa-envelope"></i></span> 
                {% if current_user.email == None %} 
                <span class="text-5 d-block text-light mt-4 mb-3">
                  <i class="far fa-circle "></i>
                </span>
                <p class="mb-0"><a class="btn-link stretched-link" href="{{url_for('users.userprofile')}}">Add Email</a></p>
              {% else %}
                <span class="text-5 d-block text-success mt-4 mb-3"><i class="fas fa-check-circle"></i></span>
                <p class="mb-0">Email Added</p>
              {% endif %}
              </div>
            </div>
            <div class="col-sm-6 col-md-3">
              <div class="border rounded p-3 text-center"> <span class="d-block text-10 text-light mt-2 mb-3"><i class="fas fa-university"></i></span>
              {% if current_user.bank_accounts == [] %} 
                <span class="text-5 d-block text-light mt-4 mb-3">
                  <i class="far fa-circle "></i>
                </span>
                <p class="mb-0"><a class="btn-link stretched-link" href="{{url_for('users.userprofile_bank_accounts')}}">Add Bank Account</a></p>
              {% else %}
                <span class="text-5 d-block text-success mt-4 mb-3"><i class="fas fa-check-circle"></i></span>
                <p class="mb-0">Bank details Added</p>
              {% endif %}
              </div>
            </div>
            <div class="col-sm-6 col-md-3 mb-4 mb-md-0">
              <div class="border rounded p-3 text-center"> <span class="d-block text-10 text-light mt-2 mb-3"><i class="fas fa-map-marker-alt"></i></span> {% if current_user.address == None %} 
                <span class="text-5 d-block text-light mt-4 mb-3">
                  <i class="far fa-circle "></i>
                </span>
                <p class="mb-0"><a class="btn-link stretched-link" href="{{url_for('users.userprofile')}}">Add Address</a></p>
              {% else %}
                <span class="text-5 d-block text-success mt-4 mb-3"><i class="fas fa-check-circle"></i></span>
                <p class="mb-0">Address Added</p>
              {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        <!-- Profile Completeness End -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item"> <a class="nav-link active" id="vendor-activities-tab" data-toggle="tab" href="#vendor-activities" role="tab" aria-controls="vendor-activities" aria-selected="true">Vendor Activities</a> </li>
          <li class="nav-item"> <a class="nav-link" id="user-activities-tab" data-toggle="tab" href="#user-activities" role="tab" aria-controls="user-activities" aria-selected="false">User Activities</a> </li>
        </ul>
          <!-- Title
          =============================== -->
          <div class="transaction-title py-2 px-4 bg-light mt-2">
            <div class="row">
              <div class="col-2 col-sm-1 text-center"><span class="">Date</span></div>
              <div class="col col-sm-7">Description</div>
              <div class="col-auto col-sm-2 d-none d-sm-block text-center">Status</div>
              <div class="col-3 col-sm-2 text-right">Amount</div>
            </div>
          </div>
          <!-- Title End -->
            <div class="tab-content" id="myTabContent">
              <div class="tab-pane fade show active" id="vendor-activities" role="tabpanel" aria-labelledby="vendor-activities-tab">
                <div class="transaction-list bg-light">
                  {% if current_user.transactions == [] %}
                  <p class="bg-primary text-center text-white p-3">No Transaction available</p>
                  {% endif %}
                  {% for transaction in (current_user.vendor_transactions + current_user.user_transactions)[:7] %}
                  <div class="transaction-item px-4 py-3" data-toggle="modal" data-target="#transaction-detail-{{transaction.id}}">
                    <div class="row align-items-center flex-row">
                      <div class="col-2 col-sm-1 text-center"> <span class="d-block text-4 font-weight-300">{{transaction.transaction_date.strftime('%d')}}</span> <span class="d-block text-1 font-weight-300 text-uppercase">{{transaction.transaction_date.strftime('%b')}} {{transaction.transaction_date.strftime('%Y')}}</span> </div>
                      <div class="col col-sm-7"><span>{{transaction.description | truncate(150)}}</span> </div>
                      <div class="col-auto col-sm-2 d-none d-sm-block text-center text-3">
                        {% if transaction.customer_fulfilled == 1 and transaction.vendor_fulfilled == 1 %}
                        <span class="text-success" data-toggle="tooltip" data-original-title="Confirmed"><i class="fas fa-check-circle"></i></span>
                        {% else %}
                        <span class="text-warning" data-toggle="tooltip" data-original-title="In Progress"><i class="fas fa-ellipsis-h"></i></span>
                        {% endif %}
                      </div>
                      <div class="col-3 col-sm-2 text-right text-3"> <span class="text-nowrap ml-n1">₦{{transaction.amount}}</span></div>
                    </div>
                  </div>
                  <!-- Transaction Item Details Modal
          =========================================== -->
          <div id="transaction-detail-{{transaction.id}}" class="modal fade" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered transaction-details" role="document">
              <div class="modal-content">
                <div class="modal-body">
                  <div class="row no-gutters">
                    <div class="col-sm-5 d-flex justify-content-center bg-primary rounded-left py-4">
                      <div class="my-auto text-center">
                        <div class="text-17 text-white my-3"><i class="fas fa-building"></i></div>
                        <h3 class="text-4 text-white font-weight-400 my-3">{{ transaction.vendor.store_name }}</h3>
                        <div class="text-8 font-weight-500 text-white my-4">₦{{transaction.amount}}</div>
                        <p class="text-white">{{transaction.transaction_date.strftime('%d %b %Y')}}</p>
                      </div>
                    </div>
                    <div class="col-sm-7">
                      <h5 class="text-5 font-weight-400 m-3">Transaction Details
                        <button type="button" class="close font-weight-400" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button>
                      </h5>
                      <hr>
                      <div class="px-3">
                        <ul class="list-unstyled">
                          <li class="mb-2">Payment Amount <span class="float-right text-3">₦{{transaction.amount}}</span></li>
                          {% if current_user == transaction.vendor %}
                          <li class="mb-2">Fee <span class="float-right text-3">-₦{{ transaction.amount * 0.010 }}</span></li>
                        </ul>
                        <hr class="mb-2">
                        <p class="d-flex align-items-center font-weight-500 mb-4">Total Amount 
                          <span class="text-3 ml-auto">₦{{transaction.amount - (transaction.amount * 0.010)}}
                          </span>
                        </p>
                          {% else %}
                          <!-- <ul class="list-unstyled"> -->
                            <li class="mb-2">Fee <span class="float-right text-3">+₦{{ transaction.amount * 0.015 }}</span></li>
                          </ul>
                          <hr class="mb-2">
                          <p class="d-flex align-items-center font-weight-500 mb-4">Total Amount 
                            <span class="text-3 ml-auto">₦{{transaction.amount + (transaction.amount * 0.015)}}
                            </span>
                          </p>
                          {% endif %}
                        <ul class="list-unstyled">
                          <li class="font-weight-500">Paid By:</li>
                          <li class="text-muted">{{transaction.buyer.fullname}}</li>
                        </ul>
                        <ul class="list-unstyled">
                          <li class="font-weight-500">Transaction ID:</li>
                          <li class="text-muted">{{transaction.transaction_id}}</li>
                        </ul>
                        <ul class="list-unstyled">
                          <li class="font-weight-500">Description:</li>
                          <li class="text-muted">{{transaction.description}}</li>
                        </ul>
                        <ul class="list-unstyled">
                          <li class="font-weight-500">Status:</li>
                          {% if transaction.customer_fulfilled == 1 and transaction.vendor_fulfilled == 1 %}
                          <li class="text-success">Completed</li>
                          {% elif transaction.customer_fulfilled == 2 or transaction.vendor_fulfilled == 2 %}
                          <li class="text-danger">Disputed</li>
                          {% else %}
                          <li class="text-warning">Pending</li>
                          {% endif %}
                        </ul>
                        {% if (transaction.customer_fulfilled and transaction.buyer == current_user) or (transaction.vendor_fulfilled and transaction.vendor == current_user) %}
                        {% else %}
                        <ul class="list-unstyled mt-2">
                          <li>
                            <a href="#fulfilled" data-toggle="modal" class="btn btn-secondary btn-sm">Fulfilled</a>
                            <a href="#dispute" data-toggle="modal" class="btn btn-outline-danger btn-sm">Dispute</a>
                          </li>
                        </ul>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Transaction Item Details Modal End -->
          <!-- Fulfilled Modal Begin -->
          <div id="fulfilled" class="modal fade " role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title font-weight-400">Fulfill Transaction</h5>
                  <button type="button" class="close font-weight-400" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button>
                </div>
                <div class="modal-body p-4">
                  <form id="fulfilled" method="post" enctype="multipart/form-data"  action="{{url_for('users.userdashboard', transaction_id=transaction.id, form_type='fulfilled')}}">
                    {{ fulfilled_form.hidden_tag() }}
                    {% from 'includes/_formhelpers.html' import render_field  %}
                    <div class="row">
                      <div class="col-12">
                        <div class="form-group">
                          {{ render_field(fulfilled_form.picture, class_="form-control", required="true") }}
                        </div>
                        {% if current_user == transaction.buyer %}
                        <div class="form-group">
                          {{ render_field(fulfilled_form.rating, class_="form-control", required="true") }}
                        </div>
                        <div class="form-group">
                          {{ render_field(fulfilled_form.buyer_comment, class_="form-control", required="true") }}
                        </div>
                        {% endif %}
                      </div>
                    </div>
                    <button class="btn btn-primary btn-block" type="submit">Submit</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <!-- Fulfilled Modal End -->

          <!-- Dispute Modal Begin -->
          <div id="dispute" class="modal fade mt-4" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title font-weight-400">Dispute Transaction</h5>
                  <button type="button" class="close font-weight-400" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button>
                </div>
                <div class="modal-body p-4">
                  <form id="dispute" method="post" enctype="multipart/form-data"  action="{{url_for('users.userdashboard', transaction_id=transaction.id, form_type='dispute')}}">
                    {{ dispute_form.hidden_tag() }}
                    {% from 'includes/_formhelpers.html' import render_field  %}
                    <div class="row">
                      <div class="col-12">
                        <div class="form-group">
                          {{ render_field(dispute_form.picture, class_="form-control") }}
                        </div>
                        {% if current_user == transaction.buyer %}
                        <div class="form-group">
                          {{ render_field(dispute_form.rating, class_="form-control", required="true") }}
                        </div>
                        {% endif %}
                        <div class="form-group">
                          {{ render_field(dispute_form.comment, class_="form-control", required="true") }}
                        </div>
                      </div>
                    </div>
                    <button class="btn btn-primary btn-block" type="submit">Submit</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <!-- Dispute Modal End -->
                  {% endfor %}
                </div>
                <div class="text-center my-4"><a href="transactions.html" class="btn-link text-3">View all<i class="fas fa-chevron-right text-2 ml-2"></i></a></div>
              </div>

              <!-- User Activities Begin -->
              <div class="tab-pane fade" id="user-activities" role="tabpanel" aria-labelledby="user-activities-tab">
                <div class="transaction-list bg-light">
                  {% for transaction in current_user.withdraws_deposits[:7] %}
                  <div class="transaction-item px-4 py-3">
                    <div class="row align-items-center flex-row">
                      <div class="col-2 col-sm-1 text-center"> <span class="d-block text-4 font-weight-300">{{transaction.transaction_date.strftime('%d')}}</span> <span class="d-block text-1 font-weight-300 text-uppercase">{{transaction.transaction_date.strftime('%b')}} {{transaction.transaction_date.strftime('%Y')}}</span> </div>
                      <div class="col col-sm-7"> <span class="d-block text-4">{{transaction.transaction_type}}</span><span class="text-muted">{{transaction.transaction_id}}</span> </div>
                      {% if transaction.status == 'pending' %}
                      <div class="col-auto col-sm-2 d-none d-sm-block text-center text-3"> <span class="text-warning" data-toggle="tooltip" data-original-title="In Progress"><i class="fas fa-ellipsis-h"></i></span>
                      </div>
                      {% else %}
                      <div class="col-auto col-sm-2 d-none d-sm-block text-center text-3"> 
                        <span class="text-success" data-toggle="tooltip" data-original-title="Complete"><i class="fas fa-check-circle"></i>
                        </span>
                      </div>
                      {% endif %}
                      {% if transaction.transaction_type == 'withdraw' %}
                      <div class="col-3 col-sm-2 text-right text-3"> <span class="text-nowrap ml-n2">-₦{{transaction.amount}}</span> </div>
                      {% else %}
                      <div class="col-3 col-sm-2 text-right text-3"> <span class="text-nowrap ml-n2">+₦{{transaction.amount}}</span> </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                </div>
                <div class="text-center my-4"><a href="#" class="btn-link text-3">View all<i class="fas fa-chevron-right text-2 ml-2"></i></a></div>
              </div>
            </div>
          
          
        </div>
        <!-- Recent Activity End -->
      </div>
      <!-- Middle Panel End -->
    </div>
  </div>
  {% endblock body %}